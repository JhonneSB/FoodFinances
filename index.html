<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FoodFinances - Gestão Financeira para Microempreendedores</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #4895ef;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --success-color: #38b000;
            --danger-color: #f72585;
            --warning-color: #ff9e00;
            --info-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --text-color: var(--dark-color);
            --text-light: #f8f9fa;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1), 0 6px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 10px;
            --border-radius-sm: 5px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            flex: 1;
            width: 100%;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            padding: 15px 0;
            text-align: center;
            box-shadow: var(--shadow-md);
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
            transform: rotate(30deg);
            pointer-events: none;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 700;
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background-color: var(--accent-color);
            border-radius: 3px;
        }

        .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 300;
            max-width: 700px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 12px;
            margin-bottom: 15px;
            transition: var(--transition);
            border: 1px solid var(--light-gray);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-title {
            color: var(--primary-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light-gray);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-title i {
            font-size: 1em;
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 12px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.85rem;
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            color: var(--gray-color);
            font-size: 0.7rem;
        }

        input,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius-sm);
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: white;
            -webkit-appearance: none;
            appearance: none;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            padding-right: 30px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background-color: var(--accent-color);
            color: var(--dark-color);
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }

        button.info {
            background-color: var(--info-color);
        }

        button.success {
            background-color: var(--success-color);
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-group button {
            flex: 1 1 auto;
            min-width: 100px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            font-size: 0.85rem;
        }

        th,
        td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: rgba(67, 97, 238, 0.03);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.success {
            background-color: rgba(56, 176, 0, 0.1);
            color: var(--success-color);
        }

        .badge.danger {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
        }

        .badge.warning {
            background-color: rgba(255, 158, 0, 0.1);
            color: var(--warning-color);
        }

        .badge.info {
            background-color: rgba(72, 149, 239, 0.1);
            color: var(--info-color);
        }

        .results {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .result-item {
            padding: 12px;
            background-color: white;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
        }

        .result-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .result-item h3 {
            color: var(--gray-color);
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profit {
            color: var(--success-color);
        }

        .loss {
            color: var(--danger-color);
        }

        .neutral {
            color: var(--gray-color);
        }

        .chart-container {
            height: 250px;
            margin-top: 15px;
            background-color: white;
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            gap: 3px;
            padding-bottom: 3px;
        }

        .tab {
            padding: 8px 5px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-color);
            position: relative;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            min-width: max-content;
            font-size: 0.75rem;
            justify-content: center;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab.active i {
            color: var(--primary-color);
        }

        .tab i {
            font-size: 0.9em;
            color: var(--gray-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .ingredient-list,
        .packaging-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ingredient-item,
        .packaging-item {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            align-items: center;
            background-color: white;
            padding: 10px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .ingredient-item:hover,
        .packaging-item:hover {
            box-shadow: var(--shadow-md);
        }

        .remove-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            width: 100%;
            height: 36px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .remove-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 5px rgba(247, 37, 133, 0.3);
        }

        .add-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: 8px;
            transition: var(--transition);
            align-self: flex-start;
        }

        .add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 10px rgba(67, 97, 238, 0.3);
        }

        footer {
            text-align: center;
            padding: 15px 10px;
            margin-top: 20px;
            background-color: var(--dark-color);
            color: var(--text-light);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            font-size: 0.85rem;
        }

        footer .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        footer a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        footer a:hover {
            color: white;
            text-decoration: underline;
        }

        .footer-links {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
            margin: 12px 0;
        }

        .footer-links a {
            color: var(--light-gray);
            font-size: 0.8rem;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 12px 0;
        }

        .social-links a {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .social-links a:hover {
            background-color: var(--primary-color);
            transform: translateY(-3px);
        }

        .print-btn {
            margin-top: 15px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Toast notifications - Completely redesigned for mobile */
        .toast {
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            max-width: 400px;
            margin: 0 auto;
            background-color: white;
            color: var(--dark-color);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
            pointer-events: none;
            border-left: 4px solid var(--primary-color);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .toast.error {
            border-left-color: var(--danger-color);
            background-color: #fff5f7;
        }

        .toast.warning {
            border-left-color: var(--warning-color);
            background-color: #fff9e6;
        }

        .toast.info {
            border-left-color: var(--info-color);
            background-color: #f0f8ff;
        }

        .toast.success {
            border-left-color: var(--success-color);
            background-color: #f0fff4;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast.error .toast-icon {
            color: var(--danger-color);
        }

        .toast.warning .toast-icon {
            color: var(--warning-color);
        }

        .toast.info .toast-icon {
            color: var(--info-color);
        }

        .toast.success .toast-icon {
            color: var(--success-color);
        }

        .close-toast {
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin-left: auto;
            opacity: 0.7;
            transition: var(--transition);
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-toast:hover {
            opacity: 1;
            color: var(--danger-color);
        }

        .toast-content {
            flex: 1;
            min-width: 0;
            padding-right: 8px;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
            color: var(--dark-color);
            line-height: 1.3;
        }

        .toast-message {
            font-size: 13px;
            color: var(--gray-color);
            line-height: 1.4;
        }

        /* Progress bar for toast */
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .toast-progress::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background-color: var(--primary-color);
            animation: progress 5s linear forwards;
            transform-origin: left;
        }

        .toast.error .toast-progress::after {
            background-color: var(--danger-color);
        }

        .toast.warning .toast-progress::after {
            background-color: var(--warning-color);
        }

        .toast.info .toast-progress::after {
            background-color: var(--info-color);
        }

        .toast.success .toast-progress::after {
            background-color: var(--success-color);
        }

        @keyframes progress {
            from {
                transform: scaleX(1);
            }
            to {
                transform: scaleX(0);
            }
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 150px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: var(--border-radius-sm);
            padding: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.7rem;
            font-weight: normal;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark-color) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Mobile Keyboard Done Button - Improved */
        .mobile-keyboard-done {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 9999;
            cursor: pointer;
            display: none;
            font-weight: 600;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 1rem;
            transition: all 0.3s ease;
            transform: translateY(100%);
            opacity: 0;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .mobile-keyboard-done.show {
            transform: translateY(0);
            opacity: 1;
        }

        .mobile-keyboard-done:active {
            background-color: var(--secondary-color);
        }

        .mobile-keyboard-done i {
            margin-right: 8px;
        }

        /* History table actions */
        .actions-cell {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .actions-cell button {
            width: auto;
            padding: 6px 8px;
            font-size: 0.75rem;
            min-width: 30px;
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            header {
                padding: 10px 0;
            }
            
            .container {
                padding: 8px;
            }
            
            .card {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .form-group {
                margin-bottom: 10px;
            }
            
            .btn-group {
                margin-top: 12px;
            }
            
            .result-item {
                padding: 8px;
            }
            
            /* Toast adjustments */
            .toast {
                bottom: 10px;
                max-width: 80%;
            }

            .mobile-keyboard-done {
                padding: 10px;
                font-size: 0.9rem;
            }
        }

        /* Mobile-specific improvements */
        @media (max-width: 767px) {
            /* Better tab navigation */
            .tabs {
                grid-template-columns: repeat(3, 1fr);
                gap: 3px;
                padding-bottom: 3px;
            }
            
            .tab {
                padding: 6px 3px;
                font-size: 0.7rem;
                justify-content: center;
            }
            
            .tab i {
                font-size: 0.8em;
            }
            
            /* Better form inputs */
            input, select {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            /* Better buttons */
            button {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            /* Better results display */
            .result-item {
                padding: 10px;
            }
            
            .result-item h3 {
                font-size: 0.75rem;
            }
            
            .result-value {
                font-size: 1rem;
            }
            
            /* Better chart container */
            .chart-container {
                height: 220px;
                padding: 8px;
            }
            
            /* Improved toast for mobile */
            .toast {
                left: 12px;
                right: 12px;
                padding: 10px;
                max-width: calc(100% - 24px);
            }
            
            .toast-icon {
                font-size: 18px;
            }
            
            .toast-title {
                font-size: 13px;
                margin-bottom: 1px;
            }
            
            .toast-message {
                font-size: 12px;
            }
            
            .close-toast {
                font-size: 16px;
                width: 20px;
                height: 20px;
            }
            
            /* Print buttons for mobile */
            .print-btn {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .print-btn button {
                width: 100%;
                margin: 0;
            }
            
            /* Better history table */
            #history-table {
                font-size: 0.8rem;
            }
            
            #history-table th,
            #history-table td {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .actions-cell button {
                padding: 4px 6px;
                font-size: 0.7rem;
            }
            
            /* Adjust ingredient and packaging items for mobile */
            .ingredient-item, .packaging-item {
                grid-template-columns: 1fr;
                gap: 6px;
                padding: 8px;
            }
            
            /* Adjust card titles */
            .card-title {
                font-size: 1rem;
            }
            
            /* Adjust footer */
            footer {
                padding: 12px 8px;
                font-size: 0.8rem;
            }
            
            .footer-links a {
                font-size: 0.75rem;
            }
            
            .social-links a {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            /* Improved mobile keyboard done button */
            .mobile-keyboard-done {
                font-size: 1rem;
                padding: 12px;
                border-radius: 10px 10px 0 0;
            }
        }

        /* Tablet and larger mobile improvements */
        @media (min-width: 480px) and (max-width: 767px) {
            .tabs {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .tab {
                font-size: 0.75rem;
                padding: 8px 4px;
            }
            
            .results {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ingredient-item {
                grid-template-columns: 2fr 1fr 1fr 1fr auto;
            }
            
            .packaging-item {
                grid-template-columns: 2fr 1fr 1fr auto;
            }
            
            .remove-btn {
                width: 32px;
                height: 32px;
                border-radius: 50%;
            }
            
            .print-btn {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .print-btn button {
                flex: 1 1 calc(50% - 4px);
            }
            
            /* Toast adjustments */
            .toast {
                max-width: 350px;
            }

            /* Improved mobile keyboard done button */
            .mobile-keyboard-done {
                font-size: 1.1rem;
                padding: 14px;
            }
        }

        /* Larger screens adjustments */
        @media (min-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .subtitle {
                font-size: 0.95rem;
            }

            .card {
                padding: 15px;
                margin-bottom: 20px;
            }

            .card-title {
                font-size: 1.2rem;
            }

            .results {
                grid-template-columns: repeat(2, 1fr);
            }

            .tabs {
                grid-template-columns: repeat(6, 1fr);
                gap: 5px;
                padding-bottom: 5px;
            }

            .tab {
                padding: 10px 5px;
                font-size: 0.85rem;
                gap: 6px;
            }

            .btn-group {
                flex-direction: row;
                gap: 10px;
            }

            button {
                width: auto;
            }

            .footer-links {
                flex-direction: row;
                gap: 15px;
            }

            .ingredient-item {
                grid-template-columns: 2fr 1fr 1fr 1fr auto;
            }

            .packaging-item {
                grid-template-columns: 2fr 1fr 1fr auto;
            }

            .remove-btn {
                width: 36px;
                height: 36px;
                border-radius: 50%;
            }
            
            /* Restore toast position for desktop */
            .toast {
                left: auto;
                right: 15px;
                transform: translateX(0) translateY(100%);
                max-width: 350px;
            }
            
            .toast.show {
                transform: translateX(0) translateY(0);
            }

            /* Hide mobile keyboard done on desktop */
            .mobile-keyboard-done {
                display: none !important;
            }
        }

        @media (min-width: 992px) {
            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
            }

            .card-title {
                font-size: 1.3rem;
            }

            .results {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }

            .result-value {
                font-size: 1.3rem;
            }

            /* History table adjustments for desktop */
            #history-table {
                display: table;
                width: 100%;
                font-size: 0.9rem;
            }

            #history-table th,
            #history-table td {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 200px;
                padding: 10px 12px;
            }

            #history-table .product-cell {
                min-width: 150px;
                max-width: 250px;
            }

            #history-table .date-cell {
                min-width: 120px;
            }

            #history-table .price-cell {
                min-width: 80px;
            }

            #history-table .profit-cell {
                min-width: 80px;
            }

            #history-table .actions-cell {
                min-width: 160px;
            }
            
            /* Show all print buttons on desktop */
            .print-btn button {
                display: inline-flex !important;
                flex: 1 1 auto;
            }
        }

        /* Responsive table for mobile */
        @media (max-width: 767px) {
            #history-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-calculator"></i> FoodFinances</h1>
            <p class="subtitle">Sua ferramenta completa para gestão financeira de alimentos e bebidas</p>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="product">
                <i class="fas fa-utensils"></i> Produto
            </div>
            <div class="tab" data-tab="ingredients">
                <i class="fas fa-carrot"></i> Ingredientes
            </div>
            <div class="tab" data-tab="packaging">
                <i class="fas fa-box-open"></i> Embalagem
            </div>
            <div class="tab" data-tab="ifood">
                <i class="fas fa-motorcycle"></i> iFood
            </div>
            <div class="tab" data-tab="results">
                <i class="fas fa-chart-line"></i> Resultados
            </div>
            <div class="tab" data-tab="history">
                <i class="fas fa-history"></i> Histórico
            </div>
        </div>

        <!-- Product Tab -->
        <div class="tab-content active" id="product-tab">
            <div class="card fade-in">
                <h2 class="card-title"><i class="fas fa-info-circle"></i> Informações do Produto</h2>
                <div class="form-group">
                    <label for="product-name">Nome do Produto</label>
                    <input type="text" id="product-name" placeholder="Ex: Brigadeiro Gourmet" inputmode="text">
                </div>
                <div class="form-group">
                    <label for="product-yield">Rendimento (quantidade produzida)</label>
                    <input type="number" id="product-yield" placeholder="Ex: 30" min="1" value="1" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="product-description">Descrição (opcional)</label>
                    <input type="text" id="product-description" placeholder="Descreva seu produto" inputmode="text">
                </div>
                <div class="btn-group">
                    <button id="save-product">
                        <i class="fas fa-save"></i> Salvar Produto
                    </button>
                </div>
            </div>
        </div>

        <!-- Ingredientes Tab -->
        <div class="tab-content" id="ingredients-tab">
            <div class="card fade-in">
                <h2 class="card-title"><i class="fas fa-carrot"></i> Ingredientes</h2>
                <p>Adicione todos os ingredientes utilizados na receita</p>

                <div class="ingredient-list" id="ingredient-list">
                    <!-- Ingredient items will be added here dynamically -->
                </div>

                <button class="add-btn" id="add-ingredient">
                    <i class="fas fa-plus"></i>
                </button>

                <div class="form-group">
                    <label for="additional-costs">Custos Adicionais (opcional)</label>
                    <input type="number" id="additional-costs" placeholder="Ex: 10,00" min="0" step="0.01" inputmode="decimal">
                    <small>Inclua custos como gás, energia, água, mão de obra, etc.</small>
                </div>

                <div class="btn-group">
                    <button id="calculate-ingredients">
                        <i class="fas fa-calculator"></i> Calcular Custo
                    </button>
                </div>
            </div>
        </div>

        <!-- Packaging Tab -->
        <div class="tab-content" id="packaging-tab">
            <div class="card fade-in">
                <h2 class="card-title"><i class="fas fa-box-open"></i> Embalagem</h2>
                <p>Adicione todos os itens de embalagem utilizados</p>

                <div class="packaging-list" id="packaging-list">
                    <!-- Packaging items will be added here dynamically -->
                </div>

                <button class="add-btn" id="add-packaging">
                    <i class="fas fa-plus"></i>
                </button>

                <div class="btn-group">
                    <button id="calculate-packaging">
                        <i class="fas fa-calculator"></i> Calcular Custo
                    </button>
                </div>
            </div>
        </div>

        <!-- iFood Tab -->
        <div class="tab-content" id="ifood-tab">
            <div class="card fade-in">
                <h2 class="card-title"><i class="fas fa-motorcycle"></i> Configurações iFood</h2>
                <div class="form-group">
                    <label for="ifood-fee">Taxa do iFood (%)</label>
                    <input type="number" id="ifood-fee" placeholder="Ex: 25" min="0" max="100" value="25" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="delivery-fee">Taxa de Entrega (R$)</label>
                    <input type="number" id="delivery-fee" placeholder="Ex: 5,00" min="0" step="0.01" value="5" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="sale-price">Preço de Venda (R$)</label>
                    <input type="number" id="sale-price" placeholder="Ex: 8,00" min="0" step="0.01" inputmode="decimal">
                </div>
                <div class="btn-group">
                    <button id="calculate-ifood">
                        <i class="fas fa-calculator"></i> Calcular Vendas
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-content" id="results-tab">
            <div class="card fade-in">
                <h2 class="card-title"><i class="fas fa-chart-pie"></i> Resultados Financeiros</h2>

                <div class="results" id="results-container">
                    <div class="result-item">
                        <h3>Custo Total da Receita</h3>
                        <span class="result-value neutral" id="total-recipe-cost">R$ 0,00</span>
                    </div>

                    <div class="result-item">
                        <h3>Custo por Unidade</h3>
                        <span class="result-value neutral" id="unit-cost">R$ 0,00</span>
                    </div>

                    <div class="result-item">
                        <h3>Preço de Venda Sugerido</h3>
                        <span class="result-value" id="suggested-price">R$ 0,00</span>
                    </div>

                    <div class="result-item">
                        <h3>Preço de Venda no iFood</h3>
                        <span class="result-value" id="ifood-price">R$ 0,00</span>
                    </div>

                    <div class="result-item">
                        <h3>Lucro por Unidade (Venda Direta)</h3>
                        <span class="result-value profit" id="unit-profit">R$ 0,00</span>
                    </div>

                    <div class="result-item">
                        <h3>Lucro por Unidade (iFood)</h3>
                        <span class="result-value profit" id="ifood-profit">R$ 0,00</span>
                    </div>

                    <div class="result-item">
                        <h3>Margem de Lucro</h3>
                        <span class="result-value profit" id="profit-margin">0%</span>
                    </div>

                    <div class="result-item">
                        <h3>Lucro Total da Receita</h3>
                        <span class="result-value profit" id="total-profit">R$ 0,00</span>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>

                <div class="btn-group print-btn">
                    <button id="save-analysis" class="success">
                        <i class="fas fa-save"></i> Salvar Análise
                    </button>
                    <button id="print-results" class="info">
                        <i class="fas fa-file-pdf"></i> Exportar Resultados
                    </button>
                    <button id="print-chart" class="info">
                        <i class="fas fa-chart-bar"></i> Exportar Gráfico
                    </button>
                    <button id="print-full-report" class="success">
                        <i class="fas fa-file-pdf"></i> Exportar Relatório Completo
                    </button>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="history-tab">
            <div class="card fade-in">
                <h2 class="card-title"><i class="fas fa-history"></i> Histórico de Análises</h2>
                <p>Aqui estão todas as análises que você salvou</p>

                <table id="history-table">
                    <thead>
                        <tr>
                            <th class="product-cell">Produto</th>
                            <th class="date-cell">Data</th>
                            <th class="price-cell">Custo Unit.</th>
                            <th class="price-cell">Preço Venda</th>
                            <th class="profit-cell">Lucro</th>
                            <th class="actions-cell">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- History items will be added here dynamically -->
                    </tbody>
                </table>

                <div class="btn-group">
                    <button id="clear-history" class="danger">
                        <i class="fas fa-trash-alt"></i> Limpar Histórico
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>FoodFinances - Sistema de Gestão Financeira para Microempreendedores de Alimentos.</p>

            <p>© <span id="current-year"></span> - Todos os direitos reservados.</p>
            <p>Desenvolvido por <a href="https://portfolio-jhonne.vercel.app/" target="_blank">Carlos Jhonne</a></p>
        </div>
    </footer>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle toast-icon"></i>
        <div class="toast-content">
            <div class="toast-title">Sucesso</div>
            <div class="toast-message" id="toast-message">Operação realizada com sucesso!</div>
        </div>
        <button class="close-toast">&times;</button>
        <div class="toast-progress"></div>
    </div>

    <div class="mobile-keyboard-done" id="mobile-keyboard-done">
        <i class="fas fa-check"></i> Concluído
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Elementos do DOM
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const productNameInput = document.getElementById('product-name');
            const productYieldInput = document.getElementById('product-yield');
            const productDescriptionInput = document.getElementById('product-description');
            const saveProductBtn = document.getElementById('save-product');
            const addIngredientBtn = document.getElementById('add-ingredient');
            const ingredientList = document.getElementById('ingredient-list');
            const additionalCostsInput = document.getElementById('additional-costs');
            const calculateIngredientsBtn = document.getElementById('calculate-ingredients');
            const addPackagingBtn = document.getElementById('add-packaging');
            const packagingList = document.getElementById('packaging-list');
            const calculatePackagingBtn = document.getElementById('calculate-packaging');
            const ifoodFeeInput = document.getElementById('ifood-fee');
            const deliveryFeeInput = document.getElementById('delivery-fee');
            const salePriceInput = document.getElementById('sale-price');
            const calculateIfoodBtn = document.getElementById('calculate-ifood');
            const saveAnalysisBtn = document.getElementById('save-analysis');
            const printResultsBtn = document.getElementById('print-results');
            const printChartBtn = document.getElementById('print-chart');
            const printFullReportBtn = document.getElementById('print-full-report');
            const clearHistoryBtn = document.getElementById('clear-history');
            const historyTable = document.getElementById('history-table').getElementsByTagName('tbody')[0];
            const toast = document.getElementById('toast');
            const closeToastBtn = document.querySelector('.close-toast');
            const toastMessage = document.getElementById('toast-message');
            const currentYearSpan = document.getElementById('current-year');
            const mobileKeyboardDone = document.getElementById('mobile-keyboard-done');

            // Verificar se é dispositivo móvel
            function isMobileDevice() {
                return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
            }

            // Configurar teclado móvel melhorado
            function setupMobileKeyboard() {
                if (!isMobileDevice()) {
                    mobileKeyboardDone.style.display = 'none';
                    return;
                }
                
                let activeInput = null;
                
                document.querySelectorAll('input, select').forEach(input => {
                    input.addEventListener('focus', function() {
                        activeInput = this;
                        mobileKeyboardDone.classList.add('show');
                        
                        // Scroll para o input com offset para o teclado
                        setTimeout(() => {
                            const inputRect = this.getBoundingClientRect();
                            const offset = window.innerHeight - inputRect.bottom - 60;
                            if (offset < 0) {
                                window.scrollBy({
                                    top: -offset,
                                    behavior: 'smooth'
                                });
                            }
                        }, 300);
                    });
                    
                    input.addEventListener('blur', function() {
                        // Pequeno delay para garantir que não esconda antes do click no botão
                        setTimeout(() => {
                            if (document.activeElement !== mobileKeyboardDone) {
                                mobileKeyboardDone.classList.remove('show');
                                activeInput = null;
                            }
                        }, 200);
                    });
                });
                
                mobileKeyboardDone.addEventListener('click', function() {
                    if (activeInput) {
                        activeInput.blur();
                    }
                    mobileKeyboardDone.classList.remove('show');
                    
                    // Pequeno scroll para cima após fechar teclado
                    setTimeout(() => {
                        window.scrollBy({
                            top: -100,
                            behavior: 'smooth'
                        });
                    }, 100);
                });
                
                // Esconder quando o teclado for fechado manualmente (Android)
                window.addEventListener('resize', function() {
                    if (!activeInput && mobileKeyboardDone.classList.contains('show')) {
                        mobileKeyboardDone.classList.remove('show');
                    }
                });
            }

            // Variáveis de estado
            let currentProduct = {
                name: '',
                yield: 1,
                description: '',
                ingredients: [],
                packaging: [],
                additionalCosts: 0,
                ifoodFee: 25,
                deliveryFee: 5,
                salePrice: 0,
                totalCost: 0,
                unitCost: 0,
                suggestedPrice: 0,
                ifoodPrice: 0,
                unitProfit: 0,
                ifoodProfit: 0,
                profitMargin: 0,
                totalProfit: 0,
                createdAt: null
            };
            
            let profitChart = null;
            let history = JSON.parse(localStorage.getItem('foodFinancesHistory')) || [];

            // Inicialização
            function init() {
                currentYearSpan.textContent = new Date().getFullYear();
                ifoodFeeInput.value = currentProduct.ifoodFee;
                deliveryFeeInput.value = currentProduct.deliveryFee;
                
                // Adiciona um ingrediente e embalagem padrão ao carregar
                addIngredientItem();
                addPackagingItem();
                
                // Configurar event listeners
                setupEventListeners();
                setupMobileKeyboard();
            }

            // Configurar event listeners
            function setupEventListeners() {
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                });

                saveProductBtn.addEventListener('click', saveProduct);
                addIngredientBtn.addEventListener('click', addIngredientItem);
                calculateIngredientsBtn.addEventListener('click', calculateIngredientsCost);
                addPackagingBtn.addEventListener('click', addPackagingItem);
                calculatePackagingBtn.addEventListener('click', calculatePackagingCost);
                calculateIfoodBtn.addEventListener('click', calculateIfoodResults);
                saveAnalysisBtn.addEventListener('click', saveAnalysis);
                printResultsBtn.addEventListener('click', printResults);
                printChartBtn.addEventListener('click', printChart);
                printFullReportBtn.addEventListener('click', printFullReport);
                clearHistoryBtn.addEventListener('click', clearHistory);
                closeToastBtn.addEventListener('click', hideToast);
            }

            // Funções de navegação
            function switchTab(tabId) {
                // Atualizar tabs ativas
                tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabId));
                tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}-tab`));

                // Ações específicas por tab
                if (tabId === 'results') calculateAll();
                if (tabId === 'history') loadHistory();
                
                // Scroll para o topo da tab no mobile
                if (isMobileDevice()) {
                    setTimeout(() => {
                        document.querySelector(`#${tabId}-tab`).scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }

            // Funções do produto
            function saveProduct() {
                currentProduct.name = productNameInput.value.trim();
                currentProduct.yield = parseInt(productYieldInput.value) || 1;
                currentProduct.description = productDescriptionInput.value.trim();

                if (!currentProduct.name) {
                    showToast('Por favor, insira um nome para o produto', 'error');
                    return;
                }

                showToast('Informações do produto salvas com sucesso!', 'success');
                switchTab('ingredients');
            }

            // Funções de ingredientes
            function addIngredientItem(ingredient = null) {
                const ingredientId = Date.now();
                const ingredientItem = document.createElement('div');
                ingredientItem.className = 'ingredient-item';
                ingredientItem.dataset.id = ingredientId;

                ingredientItem.innerHTML = `
                    <input type="text" class="ingredient-name" placeholder="Nome do ingrediente" value="${ingredient?.name || ''}" inputmode="text">
                    <input type="number" class="ingredient-quantity" placeholder="Quantidade" min="0" step="0.001" value="${ingredient?.quantity || ''}" inputmode="decimal">
                    <select class="ingredient-unit">
                        <option value="g" ${ingredient?.unit === 'g' ? 'selected' : ''}>g</option>
                        <option value="kg" ${ingredient?.unit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="ml" ${ingredient?.unit === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="l" ${ingredient?.unit === 'l' ? 'selected' : ''}>l</option>
                        <option value="un" ${ingredient?.unit === 'un' ? 'selected' : ''}>un</option>
                    </select>
                    <input type="number" class="ingredient-price" placeholder="Valor (R$)" min="0" step="0.01" value="${ingredient?.price || ''}" inputmode="decimal">
                    <button class="remove-btn" data-id="${ingredientId}">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                ingredientList.appendChild(ingredientItem);
                ingredientItem.querySelector('.remove-btn').addEventListener('click', () => ingredientItem.remove());
                
                // Focar no novo campo nome
                setTimeout(() => {
                    ingredientItem.querySelector('.ingredient-name').focus();
                }, 100);
            }

            // Funções de embalagem
            function addPackagingItem(packaging = null) {
                const packagingId = Date.now();
                const packagingItem = document.createElement('div');
                packagingItem.className = 'packaging-item';
                packagingItem.dataset.id = packagingId;

                packagingItem.innerHTML = `
                    <input type="text" class="packaging-name" placeholder="Nome da embalagem" value="${packaging?.name || ''}" inputmode="text">
                    <input type="number" class="packaging-quantity" placeholder="Quantidade" min="0" step="1" value="${packaging?.quantity || ''}" inputmode="numeric">
                    <input type="number" class="packaging-price" placeholder="Valor (R$)" min="0" step="0.01" value="${packaging?.price || ''}" inputmode="decimal">
                    <button class="remove-btn" data-id="${packagingId}">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                packagingList.appendChild(packagingItem);
                packagingItem.querySelector('.remove-btn').addEventListener('click', () => packagingItem.remove());
                
                // Focar no novo campo nome
                setTimeout(() => {
                    packagingItem.querySelector('.packaging-name').focus();
                }, 100);
            }

            // Funções de cálculo
            function calculateIngredientsCost() {
                currentProduct.ingredients = [];
                currentProduct.additionalCosts = parseFloat(additionalCostsInput.value) || 0;

                document.querySelectorAll('.ingredient-item').forEach(item => {
                    const name = item.querySelector('.ingredient-name').value.trim();
                    const quantity = parseFloat(item.querySelector('.ingredient-quantity').value) || 0;
                    const unit = item.querySelector('.ingredient-unit').value;
                    const price = parseFloat(item.querySelector('.ingredient-price').value) || 0;

                    if (name && quantity > 0 && price > 0) {
                        currentProduct.ingredients.push({ name, quantity, unit, price });
                    }
                });

                if (currentProduct.ingredients.length === 0) {
                    showToast('Adicione pelo menos um ingrediente válido', 'error');
                    return;
                }

                showToast('Custo dos ingredientes calculado com sucesso!', 'success');
                switchTab('packaging');
            }

            function calculatePackagingCost() {
                currentProduct.packaging = [];

                document.querySelectorAll('.packaging-item').forEach(item => {
                    const name = item.querySelector('.packaging-name').value.trim();
                    const quantity = parseFloat(item.querySelector('.packaging-quantity').value) || 0;
                    const price = parseFloat(item.querySelector('.packaging-price').value) || 0;

                    if (name && quantity > 0 && price > 0) {
                        currentProduct.packaging.push({ name, quantity, price });
                    }
                });

                if (currentProduct.packaging.length === 0) {
                    showToast('Adicione pelo menos um item de embalagem válido', 'error');
                    return;
                }

                showToast('Custo da embalagem calculado com sucesso!', 'success');
                switchTab('ifood');
            }

            function calculateIfoodResults() {
                currentProduct.ifoodFee = parseFloat(ifoodFeeInput.value) || 0;
                currentProduct.deliveryFee = parseFloat(deliveryFeeInput.value) || 0;
                currentProduct.salePrice = parseFloat(salePriceInput.value) || 0;

                if (currentProduct.salePrice <= 0) {
                    showToast('Insira um preço de venda válido', 'error');
                    return;
                }

                showToast('Configurações do iFood salvas com sucesso!', 'success');
                switchTab('results');
            }

            function calculateAll() {
                // Validações
                if (!currentProduct.name) {
                    showToast('Primeiro, configure as informações do produto', 'error');
                    switchTab('product');
                    return;
                }

                if (currentProduct.ingredients.length === 0) {
                    showToast('Primeiro, configure os ingredientes', 'error');
                    switchTab('ingredients');
                    return;
                }

                if (currentProduct.packaging.length === 0) {
                    showToast('Primeiro, configure a embalagem', 'error');
                    switchTab('packaging');
                    return;
                }

                // Cálculos
                const ingredientsCost = currentProduct.ingredients.reduce((sum, ing) => sum + ing.price, 0);
                const packagingCost = currentProduct.packaging.reduce((sum, pack) => sum + pack.price, 0);
                
                currentProduct.totalCost = ingredientsCost + packagingCost + currentProduct.additionalCosts;
                currentProduct.unitCost = currentProduct.totalCost / currentProduct.yield;
                currentProduct.suggestedPrice = currentProduct.unitCost * 3;
                currentProduct.ifoodPrice = currentProduct.salePrice;
                currentProduct.unitProfit = currentProduct.salePrice - currentProduct.unitCost;
                
                const ifoodFeeAmount = (currentProduct.salePrice * currentProduct.ifoodFee / 100) + currentProduct.deliveryFee;
                currentProduct.ifoodProfit = currentProduct.salePrice - currentProduct.unitCost - ifoodFeeAmount;
                currentProduct.profitMargin = ((currentProduct.salePrice - currentProduct.unitCost) / currentProduct.salePrice * 100).toFixed(2);
                currentProduct.totalProfit = currentProduct.unitProfit * currentProduct.yield;

                // Atualizar UI
                updateResultsUI();
                createProfitChart();
            }

            function updateResultsUI() {
                const format = value => 'R$ ' + parseFloat(value || 0).toFixed(2).replace('.', ',');
                
                document.getElementById('total-recipe-cost').textContent = format(currentProduct.totalCost);
                document.getElementById('unit-cost').textContent = format(currentProduct.unitCost);
                document.getElementById('suggested-price').textContent = format(currentProduct.suggestedPrice);
                document.getElementById('ifood-price').textContent = format(currentProduct.ifoodPrice);

                const setResultClass = (id, value) => {
                    const element = document.getElementById(id);
                    element.textContent = format(value);
                    element.className = `result-value ${value >= 0 ? 'profit' : 'loss'}`;
                };

                setResultClass('unit-profit', currentProduct.unitProfit);
                setResultClass('ifood-profit', currentProduct.ifoodProfit);
                
                const profitMarginElement = document.getElementById('profit-margin');
                profitMarginElement.textContent = `${currentProduct.profitMargin}%`;
                profitMarginElement.className = `result-value ${currentProduct.profitMargin >= 0 ? 'profit' : 'loss'}`;
                
                setResultClass('total-profit', currentProduct.totalProfit);
            }

            function createProfitChart() {
                const ctx = document.getElementById('profitChart').getContext('2d');
                const labels = ['Custo', 'Lucro Direto', 'Lucro iFood'];
                const data = [currentProduct.unitCost, currentProduct.unitProfit, currentProduct.ifoodProfit];
                
                if (profitChart) profitChart.destroy();

                profitChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Valor (R$)',
                            data: data,
                            backgroundColor: [
                                'rgba(108, 117, 125, 0.7)',
                                'rgba(56, 176, 0, 0.7)',
                                'rgba(67, 97, 238, 0.7)'
                            ],
                            borderColor: [
                                'rgba(108, 117, 125, 1)',
                                'rgba(56, 176, 0, 1)',
                                'rgba(67, 97, 238, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Comparação de Custos e Lucros por Unidade',
                                font: { size: isMobileDevice() ? 14 : 16 }
                            },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: context => `R$ ${context.raw.toFixed(2)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Valor (R$)'
                                }
                            }
                        }
                    }
                });
            }

            // Funções de histórico
            function saveAnalysis() {
                if (currentProduct.totalCost <= 0 || currentProduct.salePrice <= 0) {
                    showToast('Calcule os resultados antes de salvar', 'error');
                    return;
                }

                currentProduct.createdAt = new Date().toISOString();
                history.unshift({ ...currentProduct });
                
                if (history.length > 50) history = history.slice(0, 50);
                
                localStorage.setItem('foodFinancesHistory', JSON.stringify(history));
                showToast('Análise salva no histórico com sucesso!', 'success');
                loadHistory();
            }

            function loadHistory() {
                historyTable.innerHTML = '';

                if (history.length === 0) {
                    const row = historyTable.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 6;
                    cell.textContent = 'Nenhuma análise salva ainda';
                    cell.style.textAlign = 'center';
                    return;
                }

                history.forEach(item => {
                    const row = historyTable.insertRow();
                    const date = new Date(item.createdAt);

                    // Células de dados
                    row.insertCell().textContent = item.name || 'Sem nome';
                    row.insertCell().textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString().substring(0, 5);
                    row.insertCell().textContent = formatCurrency(item.unitCost);
                    row.insertCell().textContent = formatCurrency(item.salePrice);
                    
                    const profitCell = row.insertCell();
                    profitCell.textContent = formatCurrency(item.unitProfit);
                    profitCell.className = item.unitProfit >= 0 ? 'profit' : 'loss';

                    // Célula de ações
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'actions-cell';

                    const viewBtn = createActionButton('info', 'fa-eye', 'Visualizar', () => viewAnalysis(item));
                    const deleteBtn = createActionButton('danger', 'fa-trash-alt', 'Excluir', () => deleteAnalysis(item.createdAt));

                    actionsCell.appendChild(viewBtn);
                    actionsCell.appendChild(deleteBtn);
                });
            }

            function createActionButton(style, icon, title, clickHandler) {
                const button = document.createElement('button');
                button.className = style;
                button.innerHTML = `<i class="fas ${icon}"></i>`;
                button.title = title;
                button.addEventListener('click', clickHandler);
                return button;
            }

            function viewAnalysis(analysis) {
                currentProduct = { ...analysis };

                // Preencher formulários
                productNameInput.value = currentProduct.name;
                productYieldInput.value = currentProduct.yield;
                productDescriptionInput.value = currentProduct.description || '';
                
                // Ingredientes
                ingredientList.innerHTML = '';
                currentProduct.ingredients.forEach(addIngredientItem);
                additionalCostsInput.value = currentProduct.additionalCosts || 0;
                
                // Embalagem
                packagingList.innerHTML = '';
                currentProduct.packaging.forEach(addPackagingItem);
                
                // iFood
                ifoodFeeInput.value = currentProduct.ifoodFee;
                deliveryFeeInput.value = currentProduct.deliveryFee;
                salePriceInput.value = currentProduct.salePrice;

                updateResultsUI();
                createProfitChart();
                switchTab('results');
                showToast('Análise carregada com sucesso!', 'success');
            }

            function deleteAnalysis(createdAt) {
                if (confirm('Tem certeza que deseja excluir esta análise?')) {
                    history = history.filter(item => item.createdAt !== createdAt);
                    localStorage.setItem('foodFinancesHistory', JSON.stringify(history));
                    loadHistory();
                    showToast('Análise excluída com sucesso!', 'success');
                }
            }

            function clearHistory() {
                if (confirm('Tem certeza que deseja limpar todo o histórico? Esta ação não pode ser desfeita.')) {
                    history = [];
                    localStorage.removeItem('foodFinancesHistory');
                    loadHistory();
                    showToast('Histórico limpo com sucesso!', 'success');
                }
            }

            // Funções de exportação melhoradas
            function printResults() {
                showToast('Preparando relatório de resultados...', 'info');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Configurações do PDF
                const margin = 15;
                const pageWidth = pdf.internal.pageSize.getWidth() - 2 * margin;
                const lineHeight = 7;
                let yPos = margin;
                
                // Adicionar cabeçalho
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(67, 97, 238);
                pdf.setFontSize(18);
                pdf.text('FoodFinances', pageWidth / 2 + margin, yPos, { align: 'center' });
                
                pdf.setFontSize(14);
                pdf.text('Relatório de Resultados Financeiros', pageWidth / 2 + margin, yPos + lineHeight, { align: 'center' });
                
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Gerado em: ${new Date().toLocaleDateString()}`, pageWidth / 2 + margin, yPos + 2 * lineHeight, { align: 'center' });
                
                yPos += 3 * lineHeight;
                
                // Adicionar informações do produto
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(12);
                pdf.text('Informações do Produto', margin, yPos);
                yPos += lineHeight;
                
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Nome: ${currentProduct.name || 'Não informado'}`, margin, yPos);
                yPos += lineHeight;
                
                pdf.text(`Rendimento: ${currentProduct.yield} unidades`, margin, yPos);
                yPos += lineHeight;
                
                pdf.text(`Descrição: ${currentProduct.description || 'Não informada'}`, margin, yPos);
                yPos += lineHeight * 1.5;
                
                // Adicionar resultados financeiros
                pdf.setFont('helvetica', 'bold');
                pdf.text('Resultados Financeiros', margin, yPos);
                yPos += lineHeight;
                
                // Função para adicionar linha de resultado
                const addResultLine = (label, value, isProfit = false) => {
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(label, margin, yPos);
                    
                    pdf.setFont('helvetica', 'bold');
                    if (isProfit) {
                        const isPositive = parseFloat(value) >= 0;
                        pdf.setTextColor(isPositive ? 56 : 247, isPositive ? 176 : 37, isPositive ? 0 : 133);
                    }
                    
                    pdf.text(value, pageWidth + margin, yPos, { align: 'right' });
                    yPos += lineHeight;
                    
                    // Resetar cor
                    pdf.setTextColor(0, 0, 0);
                };
                
                addResultLine('Custo Total da Receita:', formatCurrency(currentProduct.totalCost));
                addResultLine('Custo por Unidade:', formatCurrency(currentProduct.unitCost));
                addResultLine('Preço de Venda Sugerido:', formatCurrency(currentProduct.suggestedPrice));
                addResultLine('Preço de Venda no iFood:', formatCurrency(currentProduct.ifoodPrice));
                addResultLine('Lucro por Unidade (Venda Direta):', formatCurrency(currentProduct.unitProfit), true);
                addResultLine('Lucro por Unidade (iFood):', formatCurrency(currentProduct.ifoodProfit), true);
                addResultLine('Margem de Lucro:', `${currentProduct.profitMargin}%`, true);
                addResultLine('Lucro Total da Receita:', formatCurrency(currentProduct.totalProfit), true);
                
                yPos += lineHeight * 0.5;
                
                // Adicionar rodapé
                pdf.setFont('helvetica', 'italic');
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text('FoodFinances - Sistema de Gestão Financeira para Microempreendedores', 
                        pageWidth / 2 + margin, pdf.internal.pageSize.getHeight() - margin, 
                        { align: 'center' });
                
                // Salvar o PDF
                pdf.save(`FoodFinances_Resultados_${currentProduct.name || 'produto'}_${new Date().toISOString().slice(0, 10)}.pdf`);
                showToast('Relatório exportado com sucesso!', 'success');
            }

            function printChart() {
                showToast('Preparando exportação do gráfico...', 'info');
                
                const canvas = document.getElementById('profitChart');
                const { jsPDF } = window.jspdf;
                
                // Criar PDF com orientação paisagem para melhor visualização
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Configurar margens
                const margin = 15;
                const pageWidth = pdf.internal.pageSize.getWidth() - 2 * margin;
                const pageHeight = pdf.internal.pageSize.getHeight() - 2 * margin;
                
                // Adicionar cabeçalho
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(67, 97, 238);
                pdf.setFontSize(16);
                pdf.text('FoodFinances - Análise Gráfica', pageWidth / 2 + margin, margin, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Produto: ${currentProduct.name || 'Não informado'}`, margin, margin + 10);
                pdf.text(`Data: ${new Date().toLocaleDateString()}`, margin, margin + 16);
                
                // Adicionar gráfico
                const imgData = canvas.toDataURL('image/png', 1.0);
                const imgWidth = pageWidth * 0.9;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Centralizar o gráfico na página
                const imgX = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
                const imgY = margin + 25;
                
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);
                
                // Adicionar legenda
                const legendY = imgY + imgHeight + 10;
                pdf.setFontSize(10);
                pdf.text('Legenda:', margin, legendY);
                
                // Itens da legenda
                const legendItems = [
                    { color: [108, 117, 125], text: 'Custo Unitário' },
                    { color: [56, 176, 0], text: 'Lucro Venda Direta' },
                    { color: [67, 97, 238], text: 'Lucro iFood' }
                ];
                
                let currentLegendY = legendY + 5;
                legendItems.forEach(item => {
                    // Caixa de cor
                    pdf.setFillColor(item.color[0], item.color[1], item.color[2]);
                    pdf.rect(margin, currentLegendY - 2, 4, 4, 'F');
                    
                    // Texto da legenda
                    pdf.text(item.text, margin + 6, currentLegendY);
                    currentLegendY += 5;
                });
                
                // Rodapé
                pdf.setFontSize(9);
                pdf.setTextColor(100, 100, 100);
                pdf.text('FoodFinances - Sistema de Gestão Financeira para Microempreendedores', 
                        pageWidth / 2 + margin, pdf.internal.pageSize.getHeight() - margin, 
                        { align: 'center' });
                
                pdf.save(`FoodFinances_Grafico_${currentProduct.name || 'produto'}_${new Date().toISOString().slice(0, 10)}.pdf`);
                showToast('Gráfico exportado com sucesso!', 'success');
            }

            function printFullReport() {
                showToast('Preparando relatório completo...', 'info');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Configurações do PDF
                const margin = 15;
                const pageWidth = pdf.internal.pageSize.getWidth() - 2 * margin;
                const lineHeight = 7;
                let yPos = margin;
                
                // Adicionar cabeçalho
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(67, 97, 238);
                pdf.setFontSize(18);
                pdf.text('FoodFinances', pageWidth / 2 + margin, yPos, { align: 'center' });
                
                pdf.setFontSize(14);
                pdf.text('Relatório Completo de Análise', pageWidth / 2 + margin, yPos + lineHeight, { align: 'center' });
                
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Gerado em: ${new Date().toLocaleDateString()}`, pageWidth / 2 + margin, yPos + 2 * lineHeight, { align: 'center' });
                
                yPos += 3 * lineHeight;
                
                // Adicionar informações do produto
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(12);
                pdf.text('Informações do Produto', margin, yPos);
                yPos += lineHeight;
                
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Nome: ${currentProduct.name || 'Não informado'}`, margin, yPos);
                yPos += lineHeight;
                
                pdf.text(`Rendimento: ${currentProduct.yield} unidades`, margin, yPos);
                yPos += lineHeight;
                
                pdf.text(`Descrição: ${currentProduct.description || 'Não informada'}`, margin, yPos);
                yPos += lineHeight * 1.5;
                
                // Adicionar resultados financeiros
                pdf.setFont('helvetica', 'bold');
                pdf.text('Resultados Financeiros', margin, yPos);
                yPos += lineHeight;
                
                // Função para adicionar linha de resultado
                const addResultLine = (label, value, isProfit = false) => {
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(label, margin, yPos);
                    
                    pdf.setFont('helvetica', 'bold');
                    if (isProfit) {
                        const isPositive = parseFloat(value) >= 0;
                        pdf.setTextColor(isPositive ? 56 : 247, isPositive ? 176 : 37, isPositive ? 0 : 133);
                    }
                    
                    pdf.text(value, pageWidth + margin, yPos, { align: 'right' });
                    yPos += lineHeight;
                    
                    // Resetar cor
                    pdf.setTextColor(0, 0, 0);
                };
                
                addResultLine('Custo Total da Receita:', formatCurrency(currentProduct.totalCost));
                addResultLine('Custo por Unidade:', formatCurrency(currentProduct.unitCost));
                addResultLine('Preço de Venda Sugerido:', formatCurrency(currentProduct.suggestedPrice));
                addResultLine('Preço de Venda no iFood:', formatCurrency(currentProduct.ifoodPrice));
                addResultLine('Lucro por Unidade (Venda Direta):', formatCurrency(currentProduct.unitProfit), true);
                addResultLine('Lucro por Unidade (iFood):', formatCurrency(currentProduct.ifoodProfit), true);
                addResultLine('Margem de Lucro:', `${currentProduct.profitMargin}%`, true);
                addResultLine('Lucro Total da Receita:', formatCurrency(currentProduct.totalProfit), true);
                
                yPos += lineHeight * 0.5;
                
                // Adicionar gráfico (em uma nova página)
                pdf.addPage();
                yPos = margin;
                
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(12);
                pdf.text('Análise Gráfica', margin, yPos);
                yPos += lineHeight;
                
                const canvas = document.getElementById('profitChart');
                const imgData = canvas.toDataURL('image/png', 1.0);
                const imgWidth = pageWidth * 0.9;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Centralizar o gráfico na página
                const imgX = (pdf.internal.pageSize.getWidth() - imgWidth) / 2;
                const imgY = yPos + 5;
                
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);
                yPos += imgHeight + 15;
                
                // Adicionar legenda
                pdf.setFontSize(10);
                pdf.text('Legenda:', margin, yPos);
                yPos += 5;
                
                // Itens da legenda
                const legendItems = [
                    { color: [108, 117, 125], text: 'Custo Unitário' },
                    { color: [56, 176, 0], text: 'Lucro Venda Direta' },
                    { color: [67, 97, 238], text: 'Lucro iFood' }
                ];
                
                legendItems.forEach(item => {
                    // Caixa de cor
                    pdf.setFillColor(item.color[0], item.color[1], item.color[2]);
                    pdf.rect(margin, yPos - 2, 4, 4, 'F');
                    
                    // Texto da legenda
                    pdf.text(item.text, margin + 6, yPos);
                    yPos += 5;
                });
                
                // Adicionar detalhes de ingredientes (em uma nova página)
                if (currentProduct.ingredients.length > 0) {
                    pdf.addPage();
                    yPos = margin;
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Detalhes dos Ingredientes', margin, yPos);
                    yPos += lineHeight;
                    
                    // Cabeçalho da tabela
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(10);
                    pdf.text('Nome', margin, yPos);
                    pdf.text('Quantidade', margin + 70, yPos);
                    pdf.text('Custo', pageWidth + margin, yPos, { align: 'right' });
                    yPos += lineHeight;
                    
                    // Linhas da tabela
                    pdf.setFont('helvetica', 'normal');
                    currentProduct.ingredients.forEach(ing => {
                        if (yPos > pdf.internal.pageSize.getHeight() - 20) {
                            pdf.addPage();
                            yPos = margin;
                        }
                        
                        pdf.text(ing.name, margin, yPos);
                        pdf.text(`${ing.quantity} ${ing.unit}`, margin + 70, yPos);
                        pdf.text(formatCurrency(ing.price), pageWidth + margin, yPos, { align: 'right' });
                        yPos += lineHeight;
                    });
                    
                    // Total
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Total:', margin + 70, yPos);
                    pdf.text(formatCurrency(currentProduct.ingredients.reduce((sum, ing) => sum + ing.price, 0)), 
                            pageWidth + margin, yPos, { align: 'right' });
                    yPos += lineHeight * 1.5;
                }
                
                // Adicionar detalhes de embalagens (em uma nova página se necessário)
                if (currentProduct.packaging.length > 0) {
                    if (yPos > pdf.internal.pageSize.getHeight() - 30) {
                        pdf.addPage();
                        yPos = margin;
                    }
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('Detalhes da Embalagem', margin, yPos);
                    yPos += lineHeight;
                    
                    // Cabeçalho da tabela
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(10);
                    pdf.text('Nome', margin, yPos);
                    pdf.text('Quantidade', margin + 70, yPos);
                    pdf.text('Custo', pageWidth + margin, yPos, { align: 'right' });
                    yPos += lineHeight;
                    
                    // Linhas da tabela
                    pdf.setFont('helvetica', 'normal');
                    currentProduct.packaging.forEach(pack => {
                        if (yPos > pdf.internal.pageSize.getHeight() - 20) {
                            pdf.addPage();
                            yPos = margin;
                        }
                        
                        pdf.text(pack.name, margin, yPos);
                        pdf.text(`${pack.quantity} un`, margin + 70, yPos);
                        pdf.text(formatCurrency(pack.price), pageWidth + margin, yPos, { align: 'right' });
                        yPos += lineHeight;
                    });
                    
                    // Total
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Total:', margin + 70, yPos);
                    pdf.text(formatCurrency(currentProduct.packaging.reduce((sum, pack) => sum + pack.price, 0)), 
                            pageWidth + margin, yPos, { align: 'right' });
                    yPos += lineHeight * 1.5;
                }
                
                // Adicionar configurações do iFood
                if (yPos > pdf.internal.pageSize.getHeight() - 30) {
                    pdf.addPage();
                    yPos = margin;
                }
                
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                pdf.text('Configurações do iFood', margin, yPos);
                yPos += lineHeight;
                
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Taxa do iFood: ${currentProduct.ifoodFee}%`, margin, yPos);
                yPos += lineHeight;
                
                pdf.text(`Taxa de Entrega: ${formatCurrency(currentProduct.deliveryFee)}`, margin, yPos);
                yPos += lineHeight;
                
                pdf.text(`Custos Adicionais: ${formatCurrency(currentProduct.additionalCosts)}`, margin, yPos);
                yPos += lineHeight;
                
                // Adicionar rodapé na última página
                pdf.setFont('helvetica', 'italic');
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text('FoodFinances - Sistema de Gestão Financeira para Microempreendedores', 
                        pageWidth / 2 + margin, pdf.internal.pageSize.getHeight() - margin, 
                        { align: 'center' });
                
                // Salvar o PDF
                pdf.save(`FoodFinances_Relatorio_Completo_${currentProduct.name || 'produto'}_${new Date().toISOString().slice(0, 10)}.pdf`);
                showToast('Relatório completo exportado com sucesso!', 'success');
            }

            // Funções auxiliares
            function showToast(message, type = 'success') {
                const icons = {
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle',
                    success: 'fa-check-circle'
                };

                const titles = {
                    error: 'Erro',
                    warning: 'Aviso',
                    info: 'Informação',
                    success: 'Sucesso'
                };

                // Resetar animação da barra de progresso
                const progress = toast.querySelector('.toast-progress');
                progress.style.animation = 'none';
                void progress.offsetWidth; // Trigger reflow
                progress.style.animation = 'progress 5s linear forwards';

                // Configurar ícone e cores
                const icon = toast.querySelector('.toast-icon');
                icon.className = `fas ${icons[type]} toast-icon`;
                
                // Configurar estilo do toast
                toast.className = `toast ${type}`;
                toast.querySelector('.toast-title').textContent = titles[type];
                toastMessage.textContent = message;
                
                // Mostrar toast
                toast.classList.add('show');

                // Auto-esconder após 5 segundos
                setTimeout(hideToast, 5000);
            }

            function hideToast() {
                toast.classList.remove('show');
            }

            function formatCurrency(value) {
                return 'R$ ' + parseFloat(value || 0).toFixed(2).replace('.', ',');
            }

            // Inicializar aplicação
            init();
        });
    </script>
</body>

</html>